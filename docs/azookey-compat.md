# azooKey Compatibility and JSON Output Rules

This document summarizes how CustardWeb generates and exports JSON compatible with azooKey, especially around flick variations and "unset" keys.

## Data Model

- Key wrapper: `KeyWrapper` carries placement only; content lives in `key`.
  - Required on wrapper: `key_type`, `specifier_type: "grid_fit"`, `specifier { x, y, width, height }`.
  - Do not put `specifier` inside `key`.
- Key content: `Key` contains `design`, `press_actions?`, `longpress_actions`, `variations`.
- Flick variations: Always prefer `FlickVariation[]` objects: `{ type: "flick_variation", direction: "left|top|right|bottom", key: Key }`.
  - Legacy `Key[]` order `[left, top, right, bottom]` is auto-converted on edit/export.

References in code:
- Preview add key (empty grid): `src/components/KeyboardDesignerV2.tsx:227`
- Add flick variation from preview: `src/components/KeyboardDesignerV2.tsx:255`
- Preview state reset only on keyboard switch: `src/components/KeyboardPreview.tsx:28`
- Export normalization: `src/lib/normalize.ts:198`

## azooKey Acceptance Requirements (observed)

- longpress_actions: Required on every Key, including each flick `variation.key`.
  - Use: `{ start: [], repeat: [], duration: "normal" }` (empty is fine, but property must exist).
- variations: Property must exist and be an array. It can be empty (`[]`).
- press_actions: Optional. If there is no action, omit the property entirely (avoid empty array).
- label: Any of the following are allowed. Empty text is accepted.
  - `{ text: "..." }`
  - `{ system_image: "..." }`
  - `{ type: "main_and_sub", main: string|{text}, sub?: string|{text} }`
- Flick directions in JSON must be `left/top/right/bottom`.

Example (valid minimal unset flick key):

```
{
  "type": "flick_variation",
  "direction": "top",
  "key": {
    "design": { "label": { "text": "" }, "color": "normal" },
    "longpress_actions": { "start": [], "repeat": [], "duration": "normal" },
    "variations": []
  }
}
```

## GUI Behaviors

- Flick layer switching persists during edits; it resets only when a different keyboard is loaded.
  - `src/components/KeyboardPreview.tsx:28`
- Empty grid cell shows "+ Key": creates a custom key at that cell using proper wrapper + minimal key content with `longpress_actions`.
  - `src/components/KeyboardDesignerV2.tsx:227`
- In flick layers, if a base key lacks that direction, a dashed "+ Key" appears on the key. Clicking it adds the missing flick variation with required fields.
  - `src/components/KeyboardDesignerV2.tsx:255`
  - Converts legacy `variations: Key[]` to `FlickVariation[]` first, then appends.

## Normalization on Export

Export uses `normalizeForAzooKey` to produce azooKey-friendly JSON:

- Ensure metadata defaults: `custard_version` and `display_name`.
- Normalize labels into one of the accepted shapes.
- Infer/clean `press_actions`:
  - If missing and label has non-empty text, create `{ type: "input", text }`.
  - If present but empty, remove the property.
- Ensure `longpress_actions` exists on all keys (top-level and flick keys), filling defaults when missing.
- Normalize variations:
  - Convert legacy `Key[]` to `FlickVariation[]` with corrected directions and normalized inner keys.
  - Remove `specifier` from inner keys.
- Filter out "unset" keys from output:
  - Drop any top-level custom key whose key has no label text, no press_actions, and no meaningful variations.
  - Also drop any flick variation whose `key` is effectively unset by the same rule.

Code reference: `src/lib/normalize.ts:198`.

## Unset Key Definition (for filtering)

A key is considered "unset" if all are true after normalization:
- Label is empty (text empty, or main/sub both empty, and not a system_image).
- `press_actions` missing or empty.
- No flick variation contains label or press actions.

This definition is used only on export; editor state keeps placeholders for UX.

## Known Pitfalls Addressed

- Variation keys missing `longpress_actions` caused azooKey import failures.
  - Fixed in preview-generated variations and normalized at export.
- Preview used to reset flick layer on any edit due to component remounting.
  - Fixed by stabilizing preview key; now resets only on keyboard switch.
- Mixed variation formats led to inconsistent JSON.
  - All paths now convert legacy to object-based flick variations before adding.

## Examples

Minimal top-level custom key generated by "+ Key" (editor state):

```
{
  "key_type": "custom",
  "specifier_type": "grid_fit",
  "specifier": { "x": 3, "y": 2, "width": 1, "height": 1 },
  "key": {
    "design": { "label": { "text": "" }, "color": "normal" },
    "longpress_actions": { "start": [], "repeat": [], "duration": "normal" },
    "variations": []
  }
}
```

After export (if still unset), the above key is omitted from JSON output.

